<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>üé§ AI Interview Chat</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <style>
    :root {
      --bg-color: #121212;
      --text-color: #e0e0e0;
    }
    body {
      background-color: var(--bg-color);
      color: var(--text-color);
    }
    h2 { color: #1976d2; }
    #chat-log { display:flex; flex-direction:column; gap:1rem; }
  </style>
</head>
<body class="d-flex flex-column min-vh-100">

  <!-- Upload Section -->
  <div id="upload-section" class="container text-center my-5">
    <h2>üé§ AI Interview Chat</h2>
    <form
      id="upload-form"
      enctype="multipart/form-data"
      class="d-flex justify-content-center align-items-center gap-3"
    >
      <input type="file" name="resume" class="form-control" required/>
      <button
        type="submit"
        id="upload-btn"
        class="btn btn-secondary d-flex align-items-center gap-2"
      >
        <span id="upload-text">Upload Resume</span>
        <span
          id="upload-spinner"
          class="spinner-border spinner-border-sm d-none"
        ></span>
      </button>
    </form>
    <button
      id="use-localstorage-btn"
      class="btn btn-outline-secondary mt-3 d-none"
    >
      Use Stored Resume
    </button>
  </div>

  <!-- Stored‚ÄëResume Modal -->
  <div
    id="localstorage-modal"
    class="modal fade"
    tabindex="-1"
    aria-labelledby="localstorage-modal-label"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <form
          id="localstorage-form"
          action="{{ url_for('upload') }}"
          method="POST"
        >
          <div class="modal-header">
            <h5 class="modal-title" id="localstorage-modal-label">
              Stored Resume
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <textarea
              id="localstorage-resume"
              name="resume_text"
              rows="10"
              class="form-control"
            ></textarea>
          </div>
          <div class="modal-footer">
            <button id="save-localstorage-btn" class="btn btn-primary">
              Save
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Start Interview -->
  <div id="start-section" class="container text-center my-5 d-none">
    <button id="start-btn" class="btn btn-primary">
      Start Interview
    </button>
  </div>

  <!-- Chat Container -->
  <div
    id="chat-container"
    class="container bg-dark text-light p-4 rounded shadow-lg d-none"
    style="opacity:0; transform:translateY(20px);
           transition:opacity 0.5s, transform 0.5s;"
  >
    <div id="chat-log" class="mb-3"></div>
    <form id="input-form" class="d-flex gap-2">
      <input
        type="text"
        id="message-input"
        class="form-control"
        placeholder="Type your answer."
        disabled
      />
      <button type="submit" class="btn btn-primary" disabled>
        Send
      </button>
    </form>
    <!-- audio controls omitted for brevity -->
  </div>

  <!-- Back to Home -->
  <div class="text-center mt-auto mb-3">
    <a href="{{ url_for('career_home') }}">
      <button class="btn btn-primary">‚Üê Return to Career Home</button>
    </a>
  </div>

  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"
  ></script>
  <script>
    // Element refs
    const uploadForm    = document.getElementById("upload-form");
    const uploadBtn     = document.getElementById("upload-btn");
    const uploadText    = document.getElementById("upload-text");
    const uploadSpinner = document.getElementById("upload-spinner");
    const useLocalBtn   = document.getElementById("use-localstorage-btn");
    const localModal    = new bootstrap.Modal(
      document.getElementById("localstorage-modal")
    );
    const localTextarea = document.getElementById("localstorage-resume");
    const saveLocalBtn  = document.getElementById("save-localstorage-btn");
    const localForm     = document.getElementById("localstorage-form");

    const startSection  = document.getElementById("start-section");
    const uploadSection = document.getElementById("upload-section");
    const startBtn      = document.getElementById("start-btn");

    const chatContainer = document.getElementById("chat-container");
    const chatLog       = document.getElementById("chat-log");
    const inputForm     = document.getElementById("input-form");
    const messageInput  = document.getElementById("message-input");
    const sendBtn       = inputForm.querySelector("button[type='submit']");

    let initialInterviewData = null;

    // Show ‚ÄúUse Stored Resume‚Äù if saved
    if (localStorage.getItem("resumeText")) {
      useLocalBtn.classList.remove("d-none");
    }

    function setupAiInterview() {
      if (initialInterviewData.resume_text) {
        localStorage.setItem("resumeText", initialInterviewData.resume_text);
        useLocalBtn.classList.remove("d-none");
      }
      startSection.classList.remove("d-none");
      uploadSection.classList.add("d-none");
    }

    async function doUpload(formData) {
      uploadBtn.disabled = true;
      uploadText.classList.add("d-none");
      uploadSpinner.classList.remove("d-none");
      try {
        const res = await fetch("{{ url_for('upload') }}", {
          method: "POST",
          body: formData,
          credentials: "include"
        });
        if (!res.ok) {
          let errMsg = res.statusText;
          try {
            const j = await res.json();
            errMsg = j.error || errMsg;
          } catch {}
          throw new Error(errMsg);
        }
        const ct = res.headers.get("content-type") || "";
        if (!ct.includes("application/json")) {
          const txt = await res.text();
          throw new Error("Unexpected response: " + txt.slice(0,200));
        }
        initialInterviewData = await res.json();
        setupAiInterview();
      } catch (err) {
        console.error("Upload failed:", err);
        alert("Failed to upload resume: " + err.message);
      } finally {
        uploadBtn.disabled = false;
        uploadText.classList.remove("d-none");
        uploadSpinner.classList.add("d-none");
      }
    }

    uploadForm.onsubmit = e => {
      e.preventDefault();
      doUpload(new FormData(uploadForm));
    };
    localForm.onsubmit = e => {
      e.preventDefault();
      doUpload(new FormData(localForm));
      localModal.hide();
    };
    useLocalBtn.onclick = () => {
      localTextarea.value = localStorage.getItem("resumeText");
      localModal.show();
    };
    saveLocalBtn.onclick = () => {
      localStorage.setItem("resumeText", localTextarea.value);
      localModal.hide();
    };

    startBtn.onclick = () => {
      if (!initialInterviewData) return;
      const d = initialInterviewData;
      addMessage("ai",
        `You're applying for <strong>${d.job_title}</strong>.${d.question}`
      );
      // ‚Ä¶ speech logic ‚Ä¶
      messageInput.disabled = false;
      sendBtn.disabled = false;
      chatContainer.classList.remove("d-none");
      chatContainer.style.opacity = "1";
      chatContainer.style.transform = "translateY(0)";
      startSection.classList.add("d-none");
    };

    inputForm.onsubmit = async e => {
      e.preventDefault();
      const txt = messageInput.value.trim();
      if (!txt) return;
      addMessage("user", txt);
      messageInput.value = "";
      const res = await fetch("{{ url_for('chat') }}", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({message: txt}),
        credentials: "include"
      });
      const data = await res.json();
      addMessage("ai", data.feedback);
      // ‚Ä¶ speech ‚Ä¶
    };

    function addMessage(who, text) {
      const d = document.createElement("div");
      d.className = `message ${who}`;
      d.innerHTML = text.replace(/\n/g, "<br>");
      chatLog.appendChild(d);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    // ‚Ä¶ rest of speech/mic code unchanged ‚Ä¶
  </script>
</body>
</html>
